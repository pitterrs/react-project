const FileUpload = function (H) {

    const FileUpload = function (element) {
        var self = this;

        self.$e = H.logEl(element, 'File Upload: ');
        self.$pe = H.logEl(element.parentElement, '|-parent element: ');
    }

    FileUpload.selector = 'input[type=file].custom-file-input';

    FileUpload.prototype = {
        updateName: function () {
            $(this.$e).value = "";
            $(this.$pe).children('.uxf-file-input-group').remove();

            if ($(this.$e).prop("files").length > 0) {

                var initialButtonWidth = $(this.$e).width();

                $(this.$e).siblings('.uxf-file-input-text').remove();
                for (var x = 0; x < $(this.$e).prop("files").length; x++) {
                    var fileName = $(this.$e).prop("files")[x]['name'];
                    if ($(this.$e).attr('multiple')) {
                        $(this.$pe).append("<div class='uxf-file-input-group'><p class='uxf-file-input-text text-truncate'>" + fileName + '</p></div>');
                    } else {
                        $(this.$pe).append("<div class='uxf-file-input-group'><p class='uxf-file-input-text text-truncate'>" + fileName + '</p><button class="btn uxf-btn-icon" aria-label="Remove File"><svg fill="#666666" focusable="false" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/><path d="M0 0h24v24H0z" fill="none"/></svg></button></div>');
                    }
                }

                $(this.$e).css('width', initialButtonWidth);

                $('.uxf-file-input-group .uxf-btn-icon').click(function () {
                    // Empties FileList array and makes sure to give back focus to label
                    $(this).parent().parent().find('input[type=file]').val('').next().focus();
                    if ($(this).parent().siblings('.uxf-file-input-group').length == 0) {
                        $(this).parent().after("<p class='uxf-file-input-text'>No file chosen</p>");
                    }
                    $(this).parent().remove();
                });

                // This allows tabbing to work correctly when opening/closing file dialog.
                // There is an issue with Firefox that prevents the label from receiving focus.
                // It looks like it is related to an open bug: https://bugzilla.mozilla.org/show_bug.cgi?id=1430196
                // TO   DO: Check status of bug and remove comments when fixed.
                $(this.$e).blur();
                $(this.$e).parent().find('.uxf-file-input').focus();
            } else {
                $(this.$pe).append("<p class='uxf-file-input-text'>No file chosen</p>");
            }
        },
        updateTabIndex: function () {
            $(this.$e).attr('tabindex', -1);
            $(this.$pe).children('.uxf-file-input').attr('tabindex', 0);
        },
        triggerFileUpload: function (e) {
            // Check if 'enter' key or 'space' key was pressed
            // Had to use 'keydown' in order for IE11 to work
            if (e.which == 13 || e.which == 32) {
                // Prevents space bar click from moving page down when file upload dialog closes
                e.preventDefault();
                $(this.$e).click();
            }
        },
        clear: function () {
            this.$e.value = "";
            $(this.$pe).children('.uxf-file-input-group').remove();
            $(this.$pe).append("<p class='uxf-file-input-text'>No file chosen</p>");
        }

    }

    H.FileUpload = function (a) {
        return new FileUpload(H.elementOrId(a));
    }

    H.Register.FileUpload = function (e) {
        H.registerEvents(FileUpload.selector, 'change', FileUpload, 'updateName', e);
        H.registerEvents(FileUpload.selector, 'immediate', FileUpload, 'updateTabIndex', e);
        H.registerEvents('.uxf-file-input', 'keydown', FileUpload, 'triggerFileUpload', e);
    }

    H.defaultRegister(H.Register.FileUpload);

};

module.exports = FileUpload;
